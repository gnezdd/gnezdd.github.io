<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="dd">
    
    <title>
        
            慢SQL治理实战总结 |
        
        dd&#39;s things
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="https://cdn.staticaly.com/gh/gnezdd/picx-images-hosting@master/20230430/ba7055311d1242c9e89edeace71377c.5j69hws5wxk0.webp">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.7.0/source/font/css/fontawesome.min.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.7.0/source/font/css/regular.min.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.7.0/source/font/css/solid.min.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.7.0/source/font/css/brands.min.css">
    
    <script id="hexo-configurations">
    let KEEP = window.KEEP || {}
    KEEP.hexo_config = {"hostname":"example.com","root":"/","language":"zh-CN","path":"search.json"}
    KEEP.theme_config = {"toc":{"enable":true,"number":false,"expand_all":true,"init_open":true},"style":{"primary_color":"#0066cc","logo":"https://cdn.staticaly.com/gh/gnezdd/picx-images-hosting@master/20230430/ba7055311d1242c9e89edeace71377c.5j69hws5wxk0.webp","favicon":"https://cdn.staticaly.com/gh/gnezdd/picx-images-hosting@master/20230430/ba7055311d1242c9e89edeace71377c.5j69hws5wxk0.webp","avatar":"https://cdn.staticaly.com/gh/gnezdd/picx-images-hosting@master/20230430/avatar.11yw6gp0tnrk.webp","font_size":null,"font_family":null,"hover":{"shadow":true,"scale":false},"first_screen":{"enable":true,"header_transparent":true,"background_img":"/images/bg.svg","description":"talk is cheap, show you the code.","font_color":null,"hitokoto":false},"scroll":{"progress_bar":true,"percent":true}},"local_search":{"enable":true,"preload":true},"code_block":{"tools":{"enable":true,"style":"mac"},"highlight_theme":"default"},"side_tools":{},"pjax":{"enable":true},"lazyload":{"enable":true},"comment":{"enable":false,"use":"valine","valine":{"appid":null,"appkey":null,"server_urls":null,"placeholder":null},"gitalk":{"github_id":null,"github_admins":null,"repository":null,"client_id":null,"client_secret":null,"proxy":null},"twikoo":{"env_id":null,"region":null,"version":"1.6.8"},"waline":{"server_url":null,"reaction":false,"version":2}},"post":{"author_label":{"enable":false,"auto":true,"custom_label_list":["Trainee","Engineer","Architect"]},"word_count":{"enable":true,"wordcount":true,"min2read":true},"img_align":"center","copyright_info":true},"website_count":{"busuanzi_count":{"enable":true,"site_uv":true,"site_pv":true,"page_pv":true}},"version":"3.7.0"}
    KEEP.language_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 个月前","year":"%s 年前"}
    KEEP.language_code_block = {"copy":"复制代码","copied":"已复制","fold":"折叠代码块","folded":"已折叠"}
    KEEP.language_copy_copyright = {"copy":"复制版权信息","copied":"已复制","title":"原文标题","author":"原文作者","link":"原文链接"}
  </script>
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
        <span class="pjax-progress-bar"></span>
        <i class="pjax-progress-icon fas fa-circle-notch fa-spin"></i>
    
</div>


<main class="page-container border-box">

    <!-- home first screen  -->
    

    <!-- page content -->
    <div class="page-main-content border-box">
        <div class="page-main-content-top">
            
<header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
                <a class="logo-image" href="/">
                    <img src="https://cdn.staticaly.com/gh/gnezdd/picx-images-hosting@master/20230430/ba7055311d1242c9e89edeace71377c.5j69hws5wxk0.webp">
                </a>
            
            <a class="site-name" href="/">
               dd&#39;s things
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                首页
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                归档
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/tags"
                            >
                                标签
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/categories"
                            >
                                分类
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">首页</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">归档</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/tags">标签</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/categories">分类</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle border-box">

            <div class="main-content border-box">

                

                    <div class="fade-in-down-animation">
    <div class="post-page-container border-box">

        <div class="article-content-container border-box">

            <div class="article-title">
                <span class="title-hover-animation">慢SQL治理实战总结</span>
            </div>

            
                <div class="article-header border-box">
                    
                        <div class="avatar-box border-box">
                            <img src="https://cdn.staticaly.com/gh/gnezdd/picx-images-hosting@master/20230430/avatar.11yw6gp0tnrk.webp">
                        </div>
                    
                    <div class="info-box">
                        <div class="author">
                            <span class="name">dd</span>
                            
                        </div>
                        <div class="meta-info">
                            <div class="article-meta-info-container border-box post">
    <div class="article-meta-info border-box">
        


        
            
                <span class="meta-info-item article-date">
                    <i class="icon fa-regular fa-calendar-plus"></i>&nbsp;
                    <span class="pc">2023-07-10 18:52:55</span>
                    <span class="mobile">2023-07-10 18:52</span>
                </span>
            

            
                <span class="meta-info-item article-update-date">
                    <i class="icon fas fa-file-pen"></i>&nbsp;
                    <span class="pc">2023-08-05 18:57:16</span>
                </span>
            
        

        
            <span class="meta-info-item article-category border-box"><i class="icon fas fa-folder"></i>&nbsp;
                <ul>
                    
                            <li class="category-item">
                                
                                <a href="/categories/MySQL/">MySQL</a>
                            </li>
                        
                    
                </ul>
            </span>
        

        
            <span class="article-tag meta-info-item border-box">
                <i class="icon fas fa-tags"></i>&nbsp;
                <ul>
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/MySQL/">MySQL</a></li>
                        
                    
                </ul>
            </span>
        

        
        
            <span class="meta-info-item article-wordcount">
                <i class="icon fas fa-file-word"></i>&nbsp;<span>4.1k 字</span>
            </span>
        
        
            <span class="meta-info-item article-min2read">
                <i class="icon fas fa-clock"></i>&nbsp;<span>14 分钟</span>
            </span>
        
        
            <span class="meta-info-item article-pv">
                <i class="icon fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
            </span>
        
    </div>

    
</div>

                        </div>
                    </div>
                </div>
            

            <div class="article-content keep-markdown-body">
                

                <p>在企业内部对于慢查SQL的优化主要经历以下的几个步骤：</p>
<p><img  
                     lazyload
                     alt="image"
                     data-src="https://cdn.staticaly.com/gh/gnezdd/picx-images-hosting@master/20230719/image.3xhybn9kwk80.webp"
                      alt="image-20230719010335758"
                ></p>
<p>在慢SQL的优化过程中，可以从以下五个角度去进行思考优化：<strong>SQL优化、资源占用、业务改造、数据减少、源头替换</strong>。</p>
<p>在治理慢查的过程中，SQL语句的使用问题是导致慢SQL的主要因素，因此本文主要从SQL优化角度出发，对慢SQL的常见原因和特征进行分析，介绍慢SQL的优化过程以及一些有效的调优技巧和工具，希望能够提供一些有用的方法和策略，帮助大家更好地应对慢SQL问题，并最终实现提升系统性能和优化用户体验的目标。</p>
<h1 id="SQL优化"><a href="#SQL优化" class="headerlink" title="SQL优化"></a>SQL优化</h1><p>SQL语句的优化方式主要是通过选择合适的索引、优化查询语句、避免全表扫描等提高查询效率，减少慢SQL的出现</p>
<h2 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h2><p>索引主要用于加快数据的查询速度，有了正确的索引，数据库就可以根据索引的数据结构快速定位到匹配的数据行，从而提高查询效率和响应速度。在慢SQL中由于索引导致的主要有两个方面：<strong>索引缺失 与 索引失效</strong></p>
<h3 id="索引缺失"><a href="#索引缺失" class="headerlink" title="索引缺失"></a>索引缺失</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from t1 where text3 = &#x27;text898&#x27;</span><br></pre></td></tr></table></figure>

<p>text3列没有索引的情况下：</p>
<p><img  
                     lazyload
                     alt="image"
                     data-src="https://cdn.staticaly.com/gh/gnezdd/picx-images-hosting@master/20230719/image.5rnazrgaz3s0.webp"
                      alt="img"
                ></p>
<p>text3列增加了索引：</p>
<p><img  
                     lazyload
                     alt="image"
                     data-src="https://cdn.staticaly.com/gh/gnezdd/picx-images-hosting@master/20230719/image.4bytt3rvevs0.webp"
                      alt="img"
                ></p>
<p><strong>建议</strong></p>
<p>一般在以下场景中需要为相应的列创建索引：</p>
<ul>
<li><strong>字段有唯一性限制</strong></li>
<li><strong>经常用于where查询条件的字段</strong></li>
<li><strong>经常用于group by 和 order by的字段，可以避免排序</strong></li>
</ul>
<p>但是并不是需要为每个字段都添加上索引，有一些场景下添加上索引反而会加重DB的负担：</p>
<ul>
<li>不用于查询条件的字段</li>
<li>字段中存在大量重复的数据</li>
<li>数据量太少</li>
<li>频繁更新的字段（考虑）</li>
</ul>
<p>注意：随着数据的增长和变化，索引的有效性可能会下降。定期评估和优化现有索引是十分必要的。可以通过删除不再使用的索引、调整索引的顺序和选择适当的索引类型等方式来进行索引维护和优化</p>
<h3 id="索引失效"><a href="#索引失效" class="headerlink" title="索引失效"></a>索引失效</h3><p>索引失效会导致SQL的执行变为全表扫描或选择错误的索引，在explain中一般是type&#x3D;ALL或type&#x3D;index</p>
<p><strong>索引失效原因：</strong></p>
<ul>
<li>索引字段发送隐式转换<ul>
<li>数字转换为字符串会发生隐式转换失效</li>
<li>字符串转换为数字是自动转换，不会导致索引失效</li>
<li><strong>通过在explain语句后增加extended<code>explain extended sql语句</code>，再执行show warnings查看是否存在隐式转换以及哪个字段存在隐式转换</strong></li>
</ul>
</li>
<li>使用 非&#x2F;不等于（!&#x3D;、not in）查询时可能会导致索引失效<ul>
<li>在满足索引覆盖的情况下可能会走索引</li>
</ul>
</li>
<li>在查询条件中对索引使用函数或表达式计算<ul>
<li>比如from_unixtime(create_time) &#x3D; ’2019-12-01’就不能使用到索引：需要先做一次全表扫描，将字段上的所有值使用表达式作用后再进行匹配，从而会导致Mysql放弃走索引。所以语句应该写成create_time &#x3D; unix_timestamp(’2019-12-01’);</li>
</ul>
</li>
<li>没有遵循最左前缀匹配原则，比如联合索引中没有使用到第一列索引、使用左右模糊匹配</li>
<li>在where子句中，or一些条件列是索引列，一些不是，会导致索引失效，直接全表扫描</li>
<li>索引的可选择性差（数据发布严重倾斜或区分度不高）<ul>
<li>MYSQL查询优化器可能认为返回的数据量本身就很多，通过索引扫描并不能减少多少开销，此时选择全表扫描的权重会提高很多</li>
<li>一般认为区分度 &gt; 0.1的查询字段可以建立索引（经验性指标，一般要进行实际的测试，比如使用前缀索引时，不断尝试直到选择到合适的前缀长度以及合适的区分度）</li>
</ul>
</li>
<li>IS NOT NULL 或 IS NULL条件查询也可能导致索引失效<ul>
<li>当索引字段不可以为空（null）时<ul>
<li>is null 不会使用索引，因为条件失效无法查询</li>
<li>只有使用is not null 返回的结果集中只包含索引字段时，才使用索引，因为实现索引覆盖，优化器认为此时成本较小</li>
</ul>
</li>
<li>当索引字段可以为空（null）时<ul>
<li>使用 is null 会使用索引，因为NULL值在SQL中被认为是列中最小的值，存储在最左边，所以可以通过索引快速定位</li>
<li>使用 is not null 返回的结果集中只包含索引字段时，才会使用索引，因为实现索引覆盖</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>总结来说，<strong>要让避免索引失效的原则为：遵循最左前缀原则、避免使用函数和表达式、避免隐式转换、尽量实现****索引覆盖</strong></p>
<p><strong>建议</strong></p>
<ul>
<li>修改SQL语句</li>
<li>force index强制使用索引</li>
<li>ignore index忽略特定索引</li>
</ul>
<h2 id="SQL语句优化"><a href="#SQL语句优化" class="headerlink" title="SQL语句优化"></a>SQL语句优化</h2><h3 id="分页写法（深翻页）"><a href="#分页写法（深翻页）" class="headerlink" title="分页写法（深翻页）"></a>分页写法（深翻页）</h3><p>最常见的分页写法就是使用limit，在分页查询时，会在 LIMIT 后面传两个参数，一个是偏移量(offset)，一个是获取的条数(limit)。</p>
<p>实现方式是先查询offset+limit条数据，再将offset条数据丢弃给用户返回剩下的limit条数据。比如limit 10000,10实际上是mysql查找到前10010条数据，之后丢弃前面的10000行后再返回</p>
<p>这样子当偏移量很小时，查询速度很快，但是随着 offset 变大时，查询速度会越来越慢，因为查找的数据越来越多</p>
<p>在limit0,10的情况下执行速度很快，基本可以忽略不计</p>
<p><img  
                     lazyload
                     alt="image"
                     data-src="https://cdn.staticaly.com/gh/gnezdd/picx-images-hosting@master/20230719/image.1aildrninz28.webp"
                      alt="img"
                ></p>
<p>但是当limit n，n是值越来越大时，就导致查询时间增加了</p>
<p><img  
                     lazyload
                     alt="image"
                     data-src="https://cdn.staticaly.com/gh/gnezdd/picx-images-hosting@master/20230719/image.3etqmm8g53e0.webp"
                      alt="img"
                ></p>
<p><strong>建议</strong></p>
<ul>
<li>方式一：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from t1 where id &gt;= 300000 order by id limit 10</span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     alt="image"
                     data-src="https://cdn.staticaly.com/gh/gnezdd/picx-images-hosting@master/20230719/image.5d04nb04v740.webp"
                      alt="img"
                ></p>
<p>避免了扫描前offset条记录</p>
<p>但是每次查询都需要拿到上一页的最大&#x2F;小id。比如当前在第3页，需要查询第5页的数据就没办法了</p>
<ul>
<li>方式二</li>
</ul>
<p>结合普通limit与方式一，解决方式二的问题，但是offset要尽量小</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from t1 where id &gt; 300000 order by id limit 10, 10</span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     alt="image"
                     data-src="https://cdn.staticaly.com/gh/gnezdd/picx-images-hosting@master/20230719/image.61rpxyqh6bw0.webp"
                      alt="img"
                ></p>
<ul>
<li>方式三：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from t1 as a inner join (select id from t1 order by id limit 300000, 10) as b on a.id = b.id order by a.id</span><br></pre></td></tr></table></figure>

<p>由于内部的子查询只扫描了id字段，而不是全表，所以性能会比较强</p>
<p><img  
                     lazyload
                     alt="image"
                     data-src="https://cdn.staticaly.com/gh/gnezdd/picx-images-hosting@master/20230719/image.2t48b7lkuqc0.webp"
                      alt="img"
                ></p>
<p>这种情况下还是扫描聚簇索引树，可能难以理解并且优化效果不是很明显。在order by换成其他字段达到索引覆盖的情况下会比较容易理解</p>
<ul>
<li>方式四：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from t1 where id &gt; (select id from t1 order by id limit 300000, 1) limit 10</span><br></pre></td></tr></table></figure>

<p>同样是通过子查询扫描字段id，但是性能会略好于方式三，因为它不需要进行表的关联，而是一个简单的比较，在不知道上一页最大id的情况下，是比较推荐的用法</p>
<p><img  
                     lazyload
                     alt="image"
                     data-src="https://cdn.staticaly.com/gh/gnezdd/picx-images-hosting@master/20230719/image.182kf0cmq2yo.webp"
                      alt="img"
                ></p>
<h3 id="最大最小写法"><a href="#最大最小写法" class="headerlink" title="最大最小写法"></a>最大最小写法</h3><p>MySQL提供了max()和min()用于获取最大最小值，但是优化得不是很好</p>
<p>text1没有索引，因此会全表扫描获取最小的id</p>
<p><img  
                     lazyload
                     alt="image"
                     data-src="https://cdn.staticaly.com/gh/gnezdd/picx-images-hosting@master/20230719/image.23fcwlaxnk4g.webp"
                      alt="img"
                ></p>
<p><strong>建议：</strong></p>
<p>由于id是主键我们可以知道第一次找到的记录对应的id就是我们需要的结果，所以可以根据结果的有序性修改SQL语句</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select id from t1 where text1 = &#x27;dd&#x27; limit 1</span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     alt="image"
                     data-src="https://cdn.staticaly.com/gh/gnezdd/picx-images-hosting@master/20230719/image.24t6ix7oc1r4.webp"
                      alt="img"
                ></p>
<p>最大值同理</p>
<h3 id="order-by排序问题"><a href="#order-by排序问题" class="headerlink" title="order by排序问题"></a>order by排序问题</h3><p>MySQL进行排序是一个成本比较高的操作：</p>
<ul>
<li>全字段排序会在sort_buffer中建立临时表进行排序</li>
<li>基于rowid排序不仅需要建立临时表，还会涉及回表操作</li>
</ul>
<p>在需要排序时会在explain的Extra字段中出现Using filesort</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from t1 where v1 &lt; 100 order by v1</span><br></pre></td></tr></table></figure>

<p><img  
                     lazyload
                     alt="image"
                     data-src="https://cdn.staticaly.com/gh/gnezdd/picx-images-hosting@master/20230719/image.2te6br6ziqu0.webp"
                      alt="img"
                ></p>
<p><strong>建议：</strong></p>
<p>对于索引是本来就是有序的，所以可以给order by字段加上索引</p>
<ul>
<li>如果order by后面的字段是单个索引，需要order by 条件要与where中条件一致，否则order by不会利用索引进行排序</li>
<li>如果order by 最后的字段是组合索引的一部分，需要把放在索引组合顺序的最后</li>
</ul>
<p><img  
                     lazyload
                     alt="image"
                     data-src="https://cdn.staticaly.com/gh/gnezdd/picx-images-hosting@master/20230719/image.2te6br6ziqu0.webp"
                      alt="img"
                ></p>
<h3 id="group-by临时表问题"><a href="#group-by临时表问题" class="headerlink" title="group by临时表问题"></a>group by临时表问题</h3><ul>
<li>内存占用：group by语句由于可能会建立内部临时表，用于保存和统计中间结果。首先会使用内存临时表，但是内存临时表的大小是有限制的，由参数 tmp_table_size 控制，当超过此限制时会把内存临时表转成磁盘临时表。因此内部临时表的存在会影响内存和磁盘的空间，且需要构造的是一个带唯一索引的表，执行代价都是比较高的。因此需要尽量避免内部临时表的建立</li>
<li>额外排序：group by column默认会根据column排序，因此还会触发排序开销问题</li>
</ul>
<p><img  
                     lazyload
                     alt="image"
                     data-src="https://cdn.staticaly.com/gh/gnezdd/picx-images-hosting@master/20230719/image.3dwgino5avs0.webp"
                      alt="img"
                ></p>
<p><strong>建议：</strong></p>
<ul>
<li>让 group by 字段用上表的索引，确认方法是 explain 的Extra结果里有没有 Using temporary 和 Using filesort；通过索引建立，只需要顺序扫描到数据结束，就可以拿到 group by 的结果，不需要临时表，也不需要再额外排序</li>
</ul>
<p><img  
                     lazyload
                     alt="image"
                     data-src="https://cdn.staticaly.com/gh/gnezdd/picx-images-hosting@master/20230719/image.1s4stl5xwj34.webp"
                      alt="img"
                ></p>
<ul>
<li>如果对 group by 语句的结果没有排序要求，要在语句后面加 order by null</li>
<li>如果 group by 需要统计的数据量不大，尽量只使用内存临时表；可以通过适当调大tmp_table_size 参数，来避免用到磁盘临时表</li>
<li>如果数据量实在太大，使用 SQL_BIG_RESULT 这个hint，来告诉优化器直接使用排序算法得到 group by 的结果</li>
</ul>
<h3 id="join"><a href="#join" class="headerlink" title="join"></a>join</h3><p>当关联被驱动表上使用到索引时，会使用 Index Nested-Loop Join （NLJ）算法</p>
<p>当关联被驱动表上没有使用到索引时（即t2的字段a无索引），会使用 Block Nested-Loop Join（BNL）算法</p>
<p><strong>建议：</strong></p>
<p>NLJ算法优化：小表驱动大表，在join的时候如果明确知道哪张表是小表时可以使用straight_join写法固定连接驱动方式</p>
<p>BNL算法优化：</p>
<ul>
<li>给被驱动表的join字段加上索引，把BNL算法转成NLJ算法</li>
<li>无法设置索引的情况可以通过设置join_buffer_size参数来控制Join Buffer的大小，以减少分段查询次数</li>
</ul>
<p>Hash Join算法优化：增加 join_buffer_size值避免生成文件</p>
<h3 id="in-exists"><a href="#in-exists" class="headerlink" title="in &amp; exists"></a>in &amp; exists</h3><p>in执行流程：查询子查询的表且内外表有关联时，先执行内层表的子查询，然后将内表和外表做一个笛卡尔积，然后按照条件进行筛选，得到结果集。所以相对内表比较小的时候，in的速度较快</p>
<p>exists执行流程：指定一个子查询，检测行的存在。遍历循环外表，然后看外表中的记录有没有和内表的数据一样的，匹配上就将结果放入结果集中</p>
<p><strong>建议：</strong></p>
<p>遵循小表驱动大表：<strong>exists是以外层表为驱动表、IN是先执行内层表的****子查询</strong>。如果子查询得出的结果集记录较少，主查询中的表较大且又有索引时应该用in；反之如果外层的主查询记录较少，子查询中的表大且又有索引时使用exists</p>
<h3 id="not-in-not-exists"><a href="#not-in-not-exists" class="headerlink" title="not in &amp; not exists"></a>not in &amp; not exists</h3><p>not in使用的是全表扫描没有用到索引；而not exists在子查询依然能用到表上的索引</p>
<p><strong>建议：</strong></p>
<p>使用not exists代替not in</p>
<h3 id="查询记录是否存在"><a href="#查询记录是否存在" class="headerlink" title="查询记录是否存在"></a>查询记录是否存在</h3><p>在很多时候开发人员判断某一条件对应的记录是否存在时会采用select count(*)，但是这样子会导致扫描所有符合条件的数据</p>
<p><strong>建议：</strong></p>
<p>改用limit 1，这样子数据库查询到一条符合条件的记录就会返回，不需要再继续查找还有多少条记录</p>
<h1 id="资源占用"><a href="#资源占用" class="headerlink" title="资源占用"></a>资源占用</h1><ul>
<li>锁资源等待：在读写很热的表上，通常会发生锁资源争夺，从而导致慢查询的情况<ul>
<li>谨慎使用for update</li>
<li>增删改尽量使用到索引</li>
<li>降低并发，避免对同一条数据进行反复修改</li>
</ul>
</li>
<li>网络波动：往客户端发送数据时发生网络波动导致的慢查询</li>
<li>硬件配置：CPU利用率高，磁盘IO经常满载，导致慢查询</li>
</ul>
<p>在高并发、高流量下，数据库所在机器的负载load过高也会导致SQL整体执行时间过长，这时可能需要从机器和实例的分配，分布式部署，分库分表，读写分离等角度进行优化</p>
<h1 id="业务改造"><a href="#业务改造" class="headerlink" title="业务改造"></a>业务改造</h1><ul>
<li>是不是真的需要全部查出来，还是取其中的top N就能够满足需求了</li>
<li>查询条件过多的情况下，能否前端页面提示限制过多的查询条件的使用</li>
<li>针对实时导出的数据，涉及到实时查DB导出大量数据时，限制导出数据量 or 走T+1的离线导出是不是也是可以的</li>
<li>现在业务上需要做数据搜索，使用了 LIKE “%关键词%” 做全模糊查询，从而导致了慢SQL。是不是可以让业务方妥协下，最右模糊匹配，这样就可以利用上索引了</li>
</ul>
<h1 id="源头替换"><a href="#源头替换" class="headerlink" title="源头替换"></a>源头替换</h1><p>Mysql并不是任何的查询场景都是适合的，如需要支持全模糊搜索时，全模糊的like是无法走到索引的。同时结合数据本身的生命周期，对于热点数据，可以考虑存储到缓存解决。因此针对不适合mysql数据源的情况，我们需要替代新的存储介质</p>
<ul>
<li>有like的全模糊的查询，比如基于文本内容去查订单信息，需要接搜索引擎解决</li>
<li>有热点数据的查询，考虑是否要接缓存解决</li>
<li>针对复杂条件的海量数据查询，可以考虑切换到OLAP(Online Analytical Processing)，可以考虑接Hybrid DB或ADB通道</li>
<li>有些场景Mysql不适用，需要用K-V的数据库，HBASE等列式存储的存储引擎</li>
</ul>
<h1 id="数据减少"><a href="#数据减少" class="headerlink" title="数据减少"></a>数据减少</h1><p>SQL本身的性能已经到达极限了，但是耗时仍然很长，可能由于数据量或索引数据都比较大了。因此需要从数据量级减少的角度去处理</p>
<ul>
<li>使用分库分表。由于单表的数据量过大，例如达到千万级别的数据了，需要使用分库分表技术拆分后减轻单库单表的单点压力</li>
<li>定时清理终态数据。针对已经状态为终态的业务单据或明显信息，可以使用idb历史数据清理的方式配置定时自动清理。如针对我们的仓储库存操作明细为完结状态的数据，我们只保留最近1天的数据在db中，其他直接删除，减少db查询压力</li>
<li>统计类查询可以单独维护汇总数据表。参考数据仓库中的数据分层设计，基于明细数据，抽出一张指标汇总表，或7天&#x2F;15天等的视图数据进行预计算。此类汇总表数据量级相比明细表下降很多，从而避免直接根据大量明细查询聚合造成慢sql</li>
</ul>
<h1 id="实践举例"><a href="#实践举例" class="headerlink" title="实践举例"></a>实践举例</h1><ul>
<li>SQL语句分析</li>
<li>分析sql时间点发现固定db某个示例会导致RT尖峰抖动，发现磁盘也有相应问题。怀疑DB某些库磁盘问题导致，联系DBA确认后进行主备切换解决</li>
<li>核销慢sql查询迟迟难以解决。发现库存核销记录每天增量数据达到百万级别，但是核销创建状态记录只有20%~30%左右，因此对完结状态的核销记录idb配置定时清理，由15天缩短到2天，减少db数据量</li>
<li>库存sn查询涉及复杂查询，采用切换到OLAP链路，通过数据同步中间件完成从db到HybridDB一键同步，切换数据源后问题解决</li>
</ul>
<h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h1><p><a class="link"   target="_blank" rel="noopener" href="https://blog.csdn.net/chuixue24/article/details/100031812" >MySQL中IS NULL、IS NOT NULL、!&#x3D;是否走索引<i class="fas fa-external-link-alt"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://www.cnblogs.com/donggebyr/p/15024890.html" >慢SQL治理实践小结<i class="fas fa-external-link-alt"></i></a></p>

            </div>

            
                <div class="post-copyright-info">
                    
<div class="article-copyright-info-container">
    <ul class="copyright-info-content">
        <li class="post-title">
            <span class="type">本文标题</span>：<span class="content">慢SQL治理实战总结</span>
        </li>
        <li class="post-author">
            <span class="type">本文作者</span>：<span class="content">dd</span>
        </li>
        <li class="post-time">
            <span class="type">创建时间</span>：<span class="content">2023-07-10 18:52:55</span>
        </li>
        <li class="post-link">
            <span class="type">本文链接</span>：<span class="content">2023/07/10/慢SQL治理实战总结/</span>
        </li>
        <li class="post-license">
            <span class="type">版权声明</span>：<span class="content">本博客所有文章除特别声明外，均采用 <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">BY-NC-SA</a> 许可协议。转载请注明出处！</span>
        </li>
    </ul>
    <div class="copy-copyright-info flex-center tooltip" data-content="复制版权信息" data-offset-y="-2px">
        <i class="fa-solid fa-copy"></i>
    </div>
</div>

                </div>
            

            
                <ul class="post-tags-box">
                    
                        <li class="tag-item">
                            <a href="/tags/MySQL/"><i class="icon fas fa-hashtag"></i>MySQL</a>&nbsp;
                        </li>
                    
                </ul>
            

            
                <div class="article-nav">
                    
                        <div class="article-prev">
                            <a class="prev"
                               rel="prev"
                               href="/2023/07/10/MySQL%E5%B8%B8%E7%94%A8%E5%85%B3%E9%94%AE%E5%AD%97%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/"
                            >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                                <span class="title flex-center">
                                <span class="post-nav-title-item text-ellipsis">MySQL常用关键字实现原理</span>
                                <span class="post-nav-item">上一篇</span>
                            </span>
                            </a>
                        </div>
                    
                    
                        <div class="article-next">
                            <a class="next"
                               rel="next"
                               href="/2023/07/09/%E6%85%A2%E6%9F%A5SQL%E5%AE%9A%E4%BD%8D%E4%B8%8E%E5%88%86%E6%9E%90/"
                            >
                            <span class="title flex-center">
                                <span class="post-nav-title-item text-ellipsis">慢查SQL定位与分析</span>
                                <span class="post-nav-item">下一篇</span>
                            </span>
                                <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                            </a>
                        </div>
                    
                </div>
            

            
                <div class="comment-container">
                    






                </div>
            
        </div>

        
            <div class="pc-post-toc">
                <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#SQL%E4%BC%98%E5%8C%96"><span class="nav-text">SQL优化</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95"><span class="nav-text">索引</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95%E7%BC%BA%E5%A4%B1"><span class="nav-text">索引缺失</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88"><span class="nav-text">索引失效</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SQL%E8%AF%AD%E5%8F%A5%E4%BC%98%E5%8C%96"><span class="nav-text">SQL语句优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E9%A1%B5%E5%86%99%E6%B3%95%EF%BC%88%E6%B7%B1%E7%BF%BB%E9%A1%B5%EF%BC%89"><span class="nav-text">分页写法（深翻页）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%80%E5%A4%A7%E6%9C%80%E5%B0%8F%E5%86%99%E6%B3%95"><span class="nav-text">最大最小写法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#order-by%E6%8E%92%E5%BA%8F%E9%97%AE%E9%A2%98"><span class="nav-text">order by排序问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#group-by%E4%B8%B4%E6%97%B6%E8%A1%A8%E9%97%AE%E9%A2%98"><span class="nav-text">group by临时表问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#join"><span class="nav-text">join</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#in-exists"><span class="nav-text">in &amp; exists</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#not-in-not-exists"><span class="nav-text">not in &amp; not exists</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E8%AE%B0%E5%BD%95%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8"><span class="nav-text">查询记录是否存在</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%B5%84%E6%BA%90%E5%8D%A0%E7%94%A8"><span class="nav-text">资源占用</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%9A%E5%8A%A1%E6%94%B9%E9%80%A0"><span class="nav-text">业务改造</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%BA%90%E5%A4%B4%E6%9B%BF%E6%8D%A2"><span class="nav-text">源头替换</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%87%8F%E5%B0%91"><span class="nav-text">数据减少</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%9E%E8%B7%B5%E4%B8%BE%E4%BE%8B"><span class="nav-text">实践举例</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="nav-text">参考文章</span></a></li></ol>
    </div>
</div>

            </div>
        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom border-box">
            
<footer class="footer border-box">
    <div class="border-box website-info-box default">
        
            <div class="copyright-info info-item default">
                &copy;&nbsp;<span>2023</span>&nbsp;-&nbsp;2023
                
                    &nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;&nbsp;<a href="/">dd</a>
                
            </div>

            <div class="theme-info info-item default">
                由&nbsp;<a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;驱动&nbsp;|&nbsp;主题&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.7.0</a>
            </div>

            

            
                <div class="deploy-info info-item default">
                    
                    <a target="_blank" rel="nofollow" href="https://github.com/">
                        
                        本站由 <span class="tooltip" data-content="GitHub Pages"><img src="/images/deploy-provider/github.png"></span> 提供部署服务
                        
                    </a>
                    
                </div>
            
        

        <div class="count-item info-item default">
            

            
                <span class="count-box border-box uv">
                    <span class="item-type border-box">访问人数</span>
                    <span class="item-value border-box uv" id="busuanzi_value_site_uv"></span>
                </span>
            

            
                <span class="count-box border-box pv">
                    <span class="item-type border-box">总访问量</span>
                    <span class="item-value border-box pv" id="busuanzi_value_site_pv"></span>
                </span>
            
        </div>
    </div>
</footer>

        </div>
    </div>

    <!-- post tools -->
    
        <div class="post-tools">
            <div class="post-tools-container border-box">
    <ul class="tools-list border-box">
        <!-- PC TOC show toggle -->
        
            <li class="tools-item flex-center toggle-show-toc">
                <i class="fas fa-list"></i>
            </li>
        

        <!-- PC go comment -->
        
    </ul>
</div>

        </div>
    

    <!-- side tools -->
    <div class="side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        
            <li class="tools-item toggle-show-toc-tablet flex-center">
                <i class="fas fa-list"></i>
            </li>
        

        

        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>

        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
    </ul>
</div>

    </div>

    <!-- image mask -->
    <div class="zoom-in-image-mask">
    <img class="zoom-in-image">
</div>


    <!-- local search -->
    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="搜索..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="close-popup-btn">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

    <!-- tablet toc -->
    
        <div class="tablet-post-toc-mask">
            <div class="tablet-post-toc">
                <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#SQL%E4%BC%98%E5%8C%96"><span class="nav-text">SQL优化</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95"><span class="nav-text">索引</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95%E7%BC%BA%E5%A4%B1"><span class="nav-text">索引缺失</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88"><span class="nav-text">索引失效</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SQL%E8%AF%AD%E5%8F%A5%E4%BC%98%E5%8C%96"><span class="nav-text">SQL语句优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E9%A1%B5%E5%86%99%E6%B3%95%EF%BC%88%E6%B7%B1%E7%BF%BB%E9%A1%B5%EF%BC%89"><span class="nav-text">分页写法（深翻页）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%80%E5%A4%A7%E6%9C%80%E5%B0%8F%E5%86%99%E6%B3%95"><span class="nav-text">最大最小写法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#order-by%E6%8E%92%E5%BA%8F%E9%97%AE%E9%A2%98"><span class="nav-text">order by排序问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#group-by%E4%B8%B4%E6%97%B6%E8%A1%A8%E9%97%AE%E9%A2%98"><span class="nav-text">group by临时表问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#join"><span class="nav-text">join</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#in-exists"><span class="nav-text">in &amp; exists</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#not-in-not-exists"><span class="nav-text">not in &amp; not exists</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E8%AE%B0%E5%BD%95%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8"><span class="nav-text">查询记录是否存在</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%B5%84%E6%BA%90%E5%8D%A0%E7%94%A8"><span class="nav-text">资源占用</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%9A%E5%8A%A1%E6%94%B9%E9%80%A0"><span class="nav-text">业务改造</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%BA%90%E5%A4%B4%E6%9B%BF%E6%8D%A2"><span class="nav-text">源头替换</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%87%8F%E5%B0%91"><span class="nav-text">数据减少</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%9E%E8%B7%B5%E4%B8%BE%E4%BE%8B"><span class="nav-text">实践举例</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="nav-text">参考文章</span></a></li></ol>
    </div>
</div>

            </div>
        </div>
    
</main>



<script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.7.0/source/js/utils.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.7.0/source/js/main.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.7.0/source/js/header-shrink.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.7.0/source/js/back2top.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.7.0/source/js/dark-light-toggle.js"></script>




    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.7.0/source/js/local-search.js"></script>



    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.7.0/source/js/code-block.js"></script>



    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.7.0/source/js/lazyload.js"></script>


<div class="post-scripts pjax">
    
        <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.7.0/source/js/post-helper.js"></script>
        
            <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.7.0/source/js/libs/anime.min.js"></script>
        
        
            <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.7.0/source/js/toc.js"></script>
        
    
    
    
</div>


    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.7.0/source/js/libs/pjax.min.js"></script>
<script>
    window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax'
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
            // scrollTo: true,
        });

        document.addEventListener('pjax:send', () => {
            KEEP.utils.pjaxProgressBarStart();
        });

        document.addEventListener('pjax:complete', () => {
            KEEP.utils.pjaxProgressBarEnd();
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
            KEEP.refresh();
        });
    });
</script>




</body>
</html>
